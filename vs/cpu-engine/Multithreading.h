#pragma once

template <typename T>
struct cpu_atomic
{
public:
	void operator=(const T& v) { val = v; }
	T Add() { return val.fetch_add(1, std::memory_order_relaxed); }

private:
	std::atomic<T> val;
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

struct cpu_tile
{
	int left;
	int top;
	int right;
	int bottom;
	int index;
	int row;
	int col;

	// Entity
	int statsDrawnTriangleCount;

	// Particle
	std::vector<int> particleLocalCounts;
	int particleCount;
	int particleOffset;
	int particleOffsetTemp;

	void Reset();
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class cpu_job : public cpu_thread
{
public:
	~cpu_job() { CloseHandle(m_hEventStart); CloseHandle(m_hEventEnd); }
	void Create(int count);
	void PostQuit();
	void PostStartEvent() { SetEvent(m_hEventStart); }
	void PostEndEvent() { SetEvent(m_hEventEnd); }
	void WaitStartEvent() { WaitForSingleObject(m_hEventStart, INFINITE); }
	void WaitEndEvent() { WaitForSingleObject(m_hEventEnd, INFINITE); }
	void OnCallback() override;

	virtual void OnJob(int iTile) = 0;

protected:
	int m_count;
	HANDLE m_hEventStart;
	HANDLE m_hEventEnd;
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class cpu_job_entity : public cpu_job
{
public:
	void OnJob(int iTile) override;
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class cpu_job_particle_space : public cpu_job
{
public:
	void OnJob(int iTile) override;
};

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class cpu_job_particle_render : public cpu_job
{
public:
	void OnJob(int iTile) override;
};
