#include "stdafx.h"

Thread::Thread()
{
	m_callback = nullptr;

	Reset();
}

Thread::~Thread()
{
	assert( m_idThread==0 );

	if ( m_idThread && m_hThread )
		TerminateThread(m_hThread, 0);

	if ( m_hThread )
		CloseHandle(m_hThread);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

bool Thread::Run()
{
	Stop();

	DWORD idThreadParent = GetCurrentThreadId();

	DWORD idThread;
	HANDLE hThread = CreateThread(nullptr, 0, ThreadProc, (void*)this, CREATE_SUSPENDED, &idThread);
	if ( hThread==nullptr )
		return false;

	m_idThreadParent = idThreadParent;
	m_hThread = hThread;
	m_idThread = idThread;
	ResumeThread(m_hThread);
	return true;
}

bool Thread::Run(const _METHOD& callback)
{
	m_callback = callback;
	return Run();
}

void Thread::Wait()
{
	if ( m_hThread )
	{
		WaitForSingleObject(m_hThread, INFINITE);
		CloseHandle(m_hThread);
		Reset();
	}
}

void Thread::Stop()
{
	m_stopping = true;
	Wait();
	Reset();
}

void Thread::PostQuit()
{
	if ( m_hThread )
	{
		PostThreadMessage(m_idThread, WM_QUIT, 0, 0);
	}
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void Thread::Reset()
{
	m_hThread = nullptr;
	m_idThread = 0;
	m_idThreadParent = 0;
	m_stopping = false;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

DWORD WINAPI Thread::ThreadProc(void* pParam)
{
	Thread* pThread = (Thread*)pParam;
	
	pThread->OnPrepare();

	if ( pThread->HasCallback() )
		pThread->OnCallback();

	pThread->OnStart();

	pThread->m_idThread = 0;
	return 0;
}
