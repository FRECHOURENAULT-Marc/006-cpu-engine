#include "stdafx.h"

void cpu_tile::Reset()
{
	// Entity
	statsDrawnTriangleCount = 0;

	// Particle
	for ( size_t i=0 ; i<particleLocalCounts.size() ; i++ )
		particleLocalCounts[i] = 0;
	particleCount = 0;
	particleOffset = 0;
	particleOffsetTemp = 0;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void cpu_job::Create(int count)
{
	m_count = count;
	m_hEventStart = CreateEvent(nullptr, FALSE, FALSE, nullptr);
	m_hEventEnd = CreateEvent(nullptr, FALSE, FALSE, nullptr);
}

void cpu_job::PostQuit()
{
	Quit();
	PostStartEvent();
	Wait();
}

void cpu_job::OnCallback()
{
	while ( true )
	{
		WaitStartEvent();

		if ( m_quitRequest )
			break;

		while ( true )
		{
			int index = cpu.NextTile();
			if ( index>=m_count )
				break;

			OnJob(index);
		}

		PostEndEvent();
	}
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void cpu_job_entity::OnJob(int iTile)
{
	cpu.Render_TileEntities(iTile);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void cpu_job_particle_space::OnJob(int iTile)
{
	cpu.Render_AssignParticleTile(iTile);
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

void cpu_job_particle_render::OnJob(int iTile)
{
	cpu.Render_TileParticles(iTile);
}
